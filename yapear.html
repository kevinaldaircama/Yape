<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Yapear</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#720e9e" />
<link rel="icon" type="image/png" href="imagen/app_icon_xxxhdpi.png">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
}

html, body {
    height: 100%;
    background-color: #f2f2f2;
}

.app {
    width: 100%;
    max-width: 480px;
    margin: auto;
    background-color: white;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Barra superior */
.topbar {
    display: flex;
    align-items: center;
    padding: 14px;
    background-color: white;
    border-bottom: 1px solid #e0e0e0;
    position: sticky;
    top: 0;
    z-index: 10;
}

.topbar .close {
    font-size: 20px;
    margin-right: 10px;
    cursor: pointer;
}

.topbar .title {
    font-size: 17px;
    font-weight: bold;
}

/* Buscador */
.search-container {
    padding: 10px;
}

.search-box {
    display: flex;
    align-items: center;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    background-color: #fafafa;
}

.search-box input {
    border: none;
    width: 100%;
    outline: none;
    font-size: 15px;
    background: transparent;
}

.search-box .icon {
    font-size: 18px;
    color: #666;
}

/* T√≠tulo secci√≥n */
.section-title {
    padding: 10px;
    font-size: 14px;
    color: black;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    background-color: #fafafa;
}

/* Lista de contactos */
.contact-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.contact {
    padding: 14px 12px;
    border-bottom: 1px solid #e8e8e8;
    cursor: pointer;
    transition: background 0.1s;
}

.contact:active {
    background-color: #f5f5f5;
}

.contact-name {
    font-size: 15px;
    color: #222;
}

.contact-number {
    font-size: 13px;
    color: #666;
    margin-top: 3px;
}

/* Estados */
.empty, .loading {
    padding: 20px;
    text-align: center;
    color: #777;
    font-size: 14px;
}

/* Responsive real */
@media (min-width: 600px) {
    .app {
        border: 1px solid #ddd;
        margin-top: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        overflow: hidden;
    }
}
</style>

</head>

<body>

<div class="app">

    <div class="topbar">
        <div class="close">‚úï</div>
        <div class="title">Yapear</div>
    </div>

    <div class="search-container">
        <div class="search-box">
            <input type="text" id="buscador" placeholder="Busca el celular o contacto">
            <div class="icon">üîç</div>
        </div>
    </div>

    <div class="section-title">
        Todos tus contactos
    </div>

    <div class="contact-list">
        <div class="loading">Cargando contactos...</div>
    </div>

</div>

<script>
// Configuraci√≥n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBHbUTYykUxlJWl6QF6L9YwhC5kNFKpwV0",
  authDomain: "apps-d075e.firebaseapp.com",
  databaseURL: "https://apps-d075e-default-rtdb.firebaseio.com",
  projectId: "apps-d075e",
  storageBucket: "apps-d075e.firebasestorage.app",
  messagingSenderId: "813273124209",
  appId: "1:813273124209:web:81030c787f0992b19e7ad0",
  measurementId: "G-6DK205T44V"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const contactList = document.querySelector(".contact-list");
const buscador = document.getElementById("buscador");

let contactosGlobal = {};

// Renderizado optimizado
function renderizarContactos(datos) {
  const fragment = document.createDocumentFragment();
  contactList.innerHTML = "";

  if (!datos || Object.keys(datos).length === 0) {
    contactList.innerHTML = `
      <div class="empty">
        No se encontraron contactos.
      </div>
    `;
    return;
  }

  Object.entries(datos).forEach(([apodo, contacto]) => {
    const nombre = contacto.nombre?.trim();
    const numero = contacto.numero?.trim();

    if (!numero) return;

    let mostrarNombre = (!apodo.startsWith("sin_apodo_") && apodo !== nombre)
      ? apodo
      : nombre || "Sin nombre";

    const div = document.createElement("div");
    div.className = "contact";
    div.onclick = () => {
      window.location.href = 'envio.html?apodo=' + encodeURIComponent(apodo);
    };

    div.innerHTML = `
      <div class="contact-name">${mostrarNombre}</div>
      <div class="contact-number">${numero}</div>
    `;

    fragment.appendChild(div);
  });

  contactList.appendChild(fragment);
}

// CARGA ULTRA R√ÅPIDA INICIAL
db.ref("contactos").once("value").then(snapshot => {
  contactosGlobal = snapshot.val() || {};
  renderizarContactos(contactosGlobal);
});

// ACTUALIZACIONES EN TIEMPO REAL SIN RECARGAR TODO
db.ref("contactos").on("child_changed", () => {
  db.ref("contactos").once("value").then(snapshot => {
    contactosGlobal = snapshot.val() || {};
    renderizarContactos(contactosGlobal);
  });
});

// Buscador optimizado
buscador.addEventListener("input", () => {
  const texto = buscador.value.toLowerCase().trim();

  if (!texto) {
    renderizarContactos(contactosGlobal);
    return;
  }

  const filtrados = {};

  Object.entries(contactosGlobal).forEach(([apodo, contacto]) => {
    const nombre = (contacto.nombre || "").toLowerCase();
    const numero = (contacto.numero || "").toLowerCase();
    const alias = apodo.toLowerCase();

    if (
      nombre.includes(texto) ||
      numero.includes(texto) ||
      alias.includes(texto)
    ) {
      filtrados[apodo] = contacto;
    }
  });

  renderizarContactos(filtrados);
});
</script>

</body>
</html>
