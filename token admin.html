<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#1f2937;
  --primary:#4e9af1;
}
body.dark{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:var(--bg);
  color:var(--text);
}

/* ===== LOGIN ===== */
#adminLogin{
  position:fixed;
  inset:0;
  background:#000000cc;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:2000;
}
.modal{
  background:#fff;
  padding:25px;
  border-radius:14px;
  width:300px;
}
#loginError{color:red;display:none}

/* ===== SIDEBAR ===== */
.sidebar{
  width:260px;
  height:100vh;
  background:#020617;
  position:fixed;
  top:0;
  left:-260px;
  padding:20px;
  transition:.3s;
  z-index:1000;
}
.sidebar.active{left:0}
.sidebar h2{
  color:#fff;
  text-align:center;
}
.sidebar a{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px;
  margin:6px 0;
  color:#cbd5f5;
  text-decoration:none;
  border-radius:10px;
}
.sidebar a.active,
.sidebar a:hover{
  background:var(--primary);
  color:#fff;
}

/* ===== OVERLAY ===== */
.overlay{
  position:fixed;
  inset:0;
  background:#00000088;
  display:none;
  z-index:900;
}
.overlay.show{display:block}

/* ===== CONTENT ===== */
.content{padding:20px}
.card{
  background:var(--card);
  padding:20px;
  border-radius:16px;
  margin-bottom:20px;
}

/* ===== HAMBURGER ===== */
.hamburger{
  width:32px;
  cursor:pointer;
  margin-bottom:20px;
}
.hamburger span{
  display:block;
  height:3px;
  background:var(--text);
  margin:6px 0;
  transition:.3s;
}
.hamburger.active span:nth-child(1){
  transform:rotate(45deg) translate(6px,6px);
}
.hamburger.active span:nth-child(2){
  opacity:0;
}
.hamburger.active span:nth-child(3){
  transform:rotate(-45deg) translate(7px,-7px);
}

/* ===== INPUTS ===== */
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
}
ul{list-style:none;padding:0}
li{
  background:#00000010;
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
}

/* ===== SWITCH ===== */
.switch{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.switch input{display:none}
.slider{
  width:52px;
  height:26px;
  background:#ccc;
  border-radius:20px;
  position:relative;
  cursor:pointer;
}
.slider::before{
  content:"";
  width:22px;
  height:22px;
  background:#fff;
  border-radius:50%;
  position:absolute;
  top:2px;
  left:2px;
  transition:.3s;
}
input:checked + .slider{
  background:var(--primary);
}
input:checked + .slider::before{
  transform:translateX(26px);
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="adminLogin">
  <div class="modal">
    <h3>Login Admin</h3>
    <input id="adminLoginEmail" placeholder="Correo admin">
    <button id="adminLoginBtn">Ingresar</button>
    <p id="loginError">Correo no autorizado</p>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<div class="sidebar" id="sidebar">
  <h2>ADMIN</h2>
  
  <a class="active" data-section="dashboard"><i class="fa fa-chart-bar"></i> Dashboard</a>
  <a data-section="generator"><i class="fa fa-key"></i> Tokens</a>
  <a data-section="search"><i class="fa fa-search"></i> Buscar</a>
  <a data-section="accounts"><i class="fa fa-users"></i> Cuentas</a>
  <a data-section="settings"><i class="fa fa-gear"></i> Configuraci√≥n</a>
</div>

<div class="content">
  <div class="hamburger" id="menuBtn">
    <span></span><span></span><span></span>
  </div>

  <div id="dashboard" class="card">
    <h3>Dashboard</h3>
    <div id="sessionInfo"></div>
<div id="advancedStats"></div>
    <div id="statsInfo"></div>
    <canvas id="statsChart"></canvas>
  </div>

  <div id="generator" class="card" style="display:none">
    <h3>Generar Token</h3>
    <input id="userName" placeholder="Nombre usuario">
    <input id="userEmail" placeholder="Correo usuario">
    <input id="userPassword" placeholder="Contrase√±a">
    <button id="generateBtn">Generar</button>
    <pre id="tokenOutput"></pre>
  </div>

  <div id="search" class="card" style="display:none">
    <h3>Buscar</h3>
    <input id="searchBox" placeholder="Buscar...">
    <ul id="searchResults"></ul>
    <button id="exportCSV">Exportar CSV</button>
    <button id="deleteAll">Eliminar todo</button>
  </div>

  <div id="accounts" class="card" style="display:none">
    <h3>Cuentas</h3>
    <ul id="accountsList"></ul>
  </div>

  <div id="settings" class="card" style="display:none">
  <h3>Configuraci√≥n</h3>

  <!-- MODO OSCURO -->
  <div class="switch">
    <span>üåô Modo oscuro</span>
    <label>
      <input type="checkbox" id="darkSwitch">
      <div class="slider"></div>
    </label>
  </div>

  <!-- TEMA AUTOM√ÅTICO -->
  <div class="switch" style="margin-top:15px">
    <span>üåì Tema autom√°tico</span>
    <label>
      <input type="checkbox" id="autoTheme">
      <div class="slider"></div>
    </label>
  </div>

  <!-- MOSTRAR GR√ÅFICOS -->
  <div class="switch" style="margin-top:15px">
    <span>üìä Mostrar gr√°ficos</span>
    <label>
      <input type="checkbox" id="toggleCharts" checked>
      <div class="slider"></div>
    </label>
  </div>

  <hr>

  <!-- EXPORT / IMPORT -->
  <button id="exportJSON">üì¶ Exportar respaldo (JSON)</button>
  <input type="file" id="importJSON" accept=".json">

  <hr>
<hr>

<div class="switch">
  <span>üöß Modo mantenimiento</span>
  <label>
    <input type="checkbox" id="maintenanceSwitch">
    <div class="slider"></div>
  </label>
</div>

<p style="margin-top:10px">
  <b>Versi√≥n:</b> <span id="appVersion"></span><br>
  <b>Build:</b> 28/01/2026
</p>
  <!-- CERRAR SESI√ìN -->
  <button id="logoutBtn" style="background:#ef4444">üö™ Cerrar sesi√≥n</button>
</div>

<!-- ===== MENU + DARK MODE ===== -->
<script>
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const menuBtn=document.getElementById("menuBtn");

menuBtn.onclick=()=>{
  sidebar.classList.toggle("active");
  overlay.classList.toggle("show");
  menuBtn.classList.toggle("active");
};
overlay.onclick=menuBtn.onclick;

document.querySelectorAll(".sidebar a").forEach(link=>{
  link.onclick=()=>{
    document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
    link.classList.add("active");
    document.querySelectorAll(".card").forEach(c=>c.style.display="none");
    document.getElementById(link.dataset.section).style.display="block";
    menuBtn.onclick();
  };
});

const darkSwitch=document.getElementById("darkSwitch");
if(localStorage.getItem("darkMode")==="true"){
  document.body.classList.add("dark");
  darkSwitch.checked=true;
}
darkSwitch.onchange=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode",darkSwitch.checked);
};
</script>

<!-- ================== TU SCRIPT FIREBASE COMPLETO ================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
  getDatabase,
  ref,
  set,
  get,
  child,
  remove,
  onValue
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBHbUTYykUxlJWl6QF6L9YwhC5kNFKpwV0",
    authDomain: "apps-d075e.firebaseapp.com",
    databaseURL: "https://apps-d075e-default-rtdb.firebaseio.com",
    projectId: "apps-d075e",
    storageBucket: "apps-d075e.firebasestorage.app",
    messagingSenderId: "813273124209",
    appId: "1:813273124209:web:81030c787f0992b19e7ad0"
  };
  
  const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
  const maintenanceSwitch = document.getElementById("maintenanceSwitch");
const maintenanceRef = ref(db, "config/maintenance/enabled");

// Estado inicial seguro
onValue(maintenanceRef, (snap) => {
  if (snap.exists()) {
    maintenanceSwitch.checked = snap.val() === true;
  } else {
    maintenanceSwitch.checked = false; // si no existe, NO mantenimiento
  }
});

// Guardar cambio
maintenanceSwitch.addEventListener("change", async () => {
  await set(maintenanceRef, maintenanceSwitch.checked);
});
const adminLoginModal = document.getElementById("adminLogin");
const adminLoginBtn = document.getElementById("adminLoginBtn");
const loginError = document.getElementById("loginError");
// ===== EXPORTAR JSON =====
document.getElementById("exportJSON").addEventListener("click", async ()=>{
  const snap = await get(child(ref(db), "tokens"));
  if(!snap.exists()) return alert("No hay datos");


  const blob = new Blob([JSON.stringify(snap.val(), null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "backup_tokens.json";
  a.click();
});

const APP_VERSION = "v1.3.0";
document.getElementById("appVersion").textContent = APP_VERSION;
// ===== IMPORTAR JSON =====
document.getElementById("importJSON").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async ()=>{
    try{
      const data = JSON.parse(reader.result);
      await set(ref(db,"tokens"), data);
      alert("‚úÖ Datos importados correctamente");
      loadStats();
      loadAccounts();
    }catch{
      alert("‚ùå Archivo inv√°lido");
    }
  };
  reader.readAsText(file);
});
// Lista de correos admin permitidos (puedes usar Firebase m√°s tarde si quieres)
const allowedAdmins = ["kevinaldaircamachoserna51@gmail.com", "tineorodrigo63@gmail.com"];

adminLoginBtn.addEventListener("click", () => {
  const email = document.getElementById("adminLoginEmail").value.trim().toLowerCase();
  if (allowedAdmins.includes(email)) {
    adminLoginModal.style.display = "none"; // cerrar modal
    localStorage.setItem("adminEmail", email); // opcional, para mantener sesi√≥n local
    alert(`Bienvenido ${email}`);
  } else {
    loginError.style.display = "block";
  }
});

// Bloquear todo el contenido si no hay admin logueado
document.addEventListener("DOMContentLoaded", () => {
  const emailStored = localStorage.getItem("adminEmail");
  if (!emailStored) {
    adminLoginModal.style.display = "flex";
  } else {
    adminLoginModal.style.display = "none";
  }
});
  

  let chart;
// === LIMPIAR TOKENS ACTIVOS DESPU√âS DE 7 D√çAS ===
async function limpiarTokensExpirados() {
  const snap = await get(child(ref(db), "tokens"));
  if (!snap.exists()) return;

  const ahora = Date.now();
  const sieteDias = 7 * 24 * 60 * 60 * 1000;

  Object.entries(snap.val()).forEach(async ([token, info]) => {
    if (!info.used && info.createdAt && (ahora - info.createdAt >= sieteDias)) {
      await remove(ref(db, "tokens/" + token));
      console.log("üóëÔ∏è Token expirado eliminado:", token);
    }
  });
}
  // === Generar token ===
document.getElementById("generateBtn").addEventListener("click", async () => {
  const admin = localStorage.getItem("adminEmail"); // admin logueado
  const email = userEmail.value.trim();
  const pass = userPassword.value.trim();
  const name = userName.value.trim();

  if (!admin || !email || !pass || !name) {
    return alert("Completa todos los campos");
  }

  const token = Math.random().toString(36).substring(2, 10);

  await set(ref(db, "tokens/" + token), {
    userEmail: email,
    userPassword: pass,
    userName: name,
    createdBy: admin,
    used: false,
    createdAt: Date.now()
  });

  const msg = `‚úÖ Token generado
Usuario: ${name}
Correo: ${email}
Contrase√±a: ${pass}
Token: ${token}
Creado por: ${admin}`;

  tokenOutput.textContent = msg;
  navigator.clipboard.writeText(msg);
});

  // === Cargar estad√≠sticas con gr√°fico ===
  async function loadStats() {
    const snap = await get(child(ref(db), "tokens"));
    const statsDiv = document.getElementById("statsInfo");
    if (!snap.exists()) {
      statsDiv.textContent = "No hay datos.";
      return;
    }
    const data = Object.values(snap.val());
    const total = data.length;
    const usados = data.filter(t => t.used).length;
    const activos = total - usados;

    statsDiv.innerHTML = `<p><b>Total:</b> ${total}</p><p><b>Usados:</b> ${usados}</p><p><b>Activos:</b> ${activos}</p>`;

    const ctx = document.getElementById("statsChart").getContext("2d");
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Total", "Usados", "Activos"],
        datasets: [{ label: "Tokens", data: [total, usados, activos], backgroundColor: ["#4e9af1", "#e67e22", "#2ecc71"] }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

// === Buscar tokens ===
document.getElementById("searchBox").addEventListener("input", async (e) => {
  const q = e.target.value.toLowerCase();
  const snap = await get(child(ref(db), "tokens"));
  const list = document.getElementById("searchResults");
  list.innerHTML = "";
  if (!snap.exists()) return;

  const data = Object.entries(snap.val())
    .filter(([k, v]) => Object.values(v).some(val => String(val).toLowerCase().includes(q)))
    // Evita errores si userName no existe
    .sort((a, b) => (a[1].userName || "").localeCompare(b[1].userName || ""));

  data.forEach(([token, info]) => {
    const li = document.createElement("li");
    const name = info.userName || "Sin nombre";
    const email = info.userEmail || "Sin correo";
    li.innerHTML = `
      <b>${name}</b> ‚Äî ${email}<br>
      <small>Token: ${token}</small><br>
      <button onclick="navigator.clipboard.writeText('${token}')">Copiar token</button>
      <button onclick="reutilizarToken('${token}')">Reutilizar</button>
    `;
    list.appendChild(li);
  });
});
// === Reutilizar token ===
window.reutilizarToken = async (token) => {
  const tokenRef = child(ref(db), "tokens/" + token);
  const snap = await get(tokenRef);
  if (!snap.exists()) return alert("Token no encontrado");

  const data = snap.val();
  await set(tokenRef, {
    ...data,
    used: false,
    reutilizadoEn: Date.now()
  });
  alert("‚úÖ Token reutilizado con √©xito");
  loadStats();
};
  // === Eliminar todo ===
  document.getElementById("deleteAll").addEventListener("click", async () => {
    if (confirm("‚ö†Ô∏è ¬øSeguro que deseas eliminar TODAS las cuentas y tokens?")) {
      await remove(ref(db, "tokens"));
      alert("‚úÖ Todos los datos han sido eliminados");
      loadStats();
    }
  });

  // === Exportar CSV ===
  document.getElementById("exportCSV").addEventListener("click", async () => {
    const snap = await get(child(ref(db), "tokens"));
    if (!snap.exists()) return alert("No hay tokens");
    const data = snap.val();
    let csv = "Token,Usuario,Correo,Contrase√±a,Creado por,Fecha\n";
    Object.entries(data).forEach(([t, i]) => {
      csv += `${t},${i.userName},${i.userEmail},${i.userPassword},${i.createdBy},${new Date(i.createdAt).toLocaleString()}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "tokens.csv";
    a.click();
  });

  // === Cargar cuentas ===
  async function loadAccounts() {
    const snap = await get(child(ref(db), "tokens"));
    const list = document.getElementById("accountsList");
    list.innerHTML = "";
    if (!snap.exists()) return list.innerHTML = "<li>No hay cuentas</li>";
    Object.entries(snap.val()).forEach(([t, i]) => {
      const li = document.createElement("li");
      li.textContent = `${i.userName} (${i.userEmail})`;
      list.appendChild(li);
    });
  }

  setInterval(() => {
  limpiarTokensExpirados();
  loadStats();
  loadAccounts();
  loadAdvancedStats();
}, 5000);


  limpiarTokensExpirados();
loadStats();
loadAccounts();
  
/* ===== CERRAR SESI√ìN ===== */
document.getElementById("logoutBtn").onclick = () => {
  if(confirm("¬øCerrar sesi√≥n?")){
    localStorage.removeItem("adminEmail");
    location.reload();
  }
};

/* ===== INACTIVIDAD 30 MIN ===== */
let inactivityTimer;
const MAX_INACTIVE = 30 * 60 * 1000;

function resetInactivity(){
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(()=>{
    alert("Sesi√≥n cerrada por inactividad");
    localStorage.removeItem("adminEmail");
    location.reload();
  }, MAX_INACTIVE);
}
["click","mousemove","keydown","touchstart"].forEach(e=>{
  document.addEventListener(e, resetInactivity);
});
resetInactivity();

/* ===== TEMA AUTOM√ÅTICO ===== */
const autoTheme = document.getElementById("autoTheme");
if(localStorage.getItem("autoTheme")==="true"){
  autoTheme.checked = true;
  applyAutoTheme();
}

autoTheme.onchange = ()=>{
  localStorage.setItem("autoTheme", autoTheme.checked);
  if(autoTheme.checked) applyAutoTheme();
};

function applyAutoTheme(){
  const hour = new Date().getHours();
  const dark = hour >= 18 || hour <= 6;
  document.body.classList.toggle("dark", dark);
  darkSwitch.checked = dark;
}

/* ===== MOSTRAR / OCULTAR GR√ÅFICOS ===== */
const toggleCharts = document.getElementById("toggleCharts");
const chartCanvas = document.getElementById("statsChart");

toggleCharts.onchange = ()=>{
  chartCanvas.style.display = toggleCharts.checked ? "block" : "none";
  localStorage.setItem("showCharts", toggleCharts.checked);
};

if(localStorage.getItem("showCharts")==="false"){
  toggleCharts.checked = false;
  chartCanvas.style.display = "none";
}

let sessionStart = Date.now();

function updateSessionInfo(){
  const admin = localStorage.getItem("adminEmail");
  if(!admin) return;

  const mins = Math.floor((Date.now() - sessionStart)/60000);
  document.getElementById("sessionInfo").innerHTML = `
    <p>üë§ <b>Admin:</b> ${admin}</p>
    <p>‚è±Ô∏è <b>Tiempo activo:</b> ${mins} min</p>
  `;
}
setInterval(updateSessionInfo, 60000);
updateSessionInfo();

async function loadAdvancedStats(){
  const snap = await get(child(ref(db), "tokens"));
  if(!snap.exists()) return;

  const tokens = Object.values(snap.val());
  const now = Date.now();

  const hoy = tokens.filter(t => now - t.createdAt < 86400000).length;
  const semana = tokens.filter(t => now - t.createdAt < 604800000).length;
  const mes = tokens.filter(t => now - t.createdAt < 2592000000).length;

  document.getElementById("advancedStats").innerHTML = `
    <p>üìÖ Tokens hoy: <b>${hoy}</b></p>
    <p>üóìÔ∏è √öltimos 7 d√≠as: <b>${semana}</b></p>
    <p>üìÜ √öltimos 30 d√≠as: <b>${mes}</b></p>
  `;
}

</script>

</body>
</html>
