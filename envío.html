<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seleccionar Destino</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#720e9e" />

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #fff;
}

.title-bar {
  display: flex;
  justify-content: space-between;
  padding: 15px;
  border-bottom: 1px solid #ddd;
}

.options {
  padding: 10px;
}

.option-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
}

.option-card span {
  font-weight: bold;
  display: block;
}

.option-card small {
  color: #666;
}

.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 350px;
}

input {
  width: 100%;
  padding: 8px;
  margin: 5px 0;
}

button {
  padding: 10px;
  margin-top: 10px;
}
</style>
</head>

<body>

<div class="title-bar">
  <span>Seleccionar Destino</span>
  <button onclick="history.back()">X</button>
</div>

<div class="options" id="lista-destinos"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Confirmar Envío</h3>

    <p id="info"></p>

    <input id="nombre" placeholder="Nombre del destinatario">
    <input id="monto" placeholder="Monto">
    <input id="digitos" placeholder="3 últimos dígitos">

    <button onclick="confirmar()">Confirmar</button>
    <button onclick="cerrar()">Cancelar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyBHbUTYykUxlJWl6QF6L9YwhC5kNFKpwV0",
  authDomain: "apps-d075e.firebaseapp.com",
  databaseURL: "https://apps-d075e-default-rtdb.firebaseio.com",
  projectId: "apps-d075e",
  storageBucket: "apps-d075e.firebasestorage.app",
  messagingSenderId: "813273124209",
  appId: "1:813273124209:web:81030c787f0992b19e7ad0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const lista = document.getElementById("lista-destinos");

let seleccionado = "";

function destinoValido(d) {
  const invalidos = ["sin destino", "***", "a", "b", "x", "yape", "plin"];
  return d && d.length > 2 && !invalidos.includes(d.toLowerCase());
}

db.ref("contactos").on("value", snap => {

  lista.innerHTML = "";

  const numeros = {};

  snap.forEach(c => {
    const data = c.val();
    const num = data.numero;
    const dest = data.destino;
    const nom = data.nombre || "Sin nombre";

    if (!num || !destinoValido(dest)) return;

    if (!numeros[num]) {
      numeros[num] = {
        nombre: nom,
        destinos: new Set()
      };
    }

    numeros[num].destinos.add(dest);
  });

  let hay = false;

  for (let num in numeros) {
    if (numeros[num].destinos.size > 1) {

      hay = true;

      const card = document.createElement("div");
      card.className = "option-card";

      card.innerHTML = `
        <span>${numeros[num].nombre}</span>
        <small>${num}</small>
        <small>${[...numeros[num].destinos].join(" / ")}</small>
      `;

      card.onclick = () => abrir(num, numeros[num].nombre);

      lista.appendChild(card);
    }
  }

  if (!hay) {
    lista.innerHTML = "<p>No hay números con múltiples destinos.</p>";
  }

});

function abrir(numero, nombre) {
  seleccionado = numero;
  document.getElementById("info").innerText =
    "Enviar a: " + nombre + " (" + numero + ")";
  document.getElementById("modal").style.display = "flex";
}

function cerrar() {
  document.getElementById("modal").style.display = "none";
}

function confirmar() {
  const nombre = document.getElementById("nombre").value;
  const monto = document.getElementById("monto").value;
  const dig = document.getElementById("digitos").value;

  if (!nombre || !monto || !dig) {
    alert("Completa todos los campos");
    return;
  }

  alert("Listo para enviar a " + seleccionado);
  cerrar();
}

</script>

</body>
</html>
